{% extends 'base.html' %}

{% block content %}
  <div class="grid">
    <details class="quick-guide quick-guide--home">
      <summary><span class="guide-icon">üè†</span>Guia r√°pido (clique para abrir)</summary>
      <div class="guide-steps">
        <div class="guide-step">
          <span>1</span>
          <p>Cadastre a pe√ßa (ex.: c√≥digo MO-0001, tipo Moletom, tamanho G). Ela entra como <strong>ativa</strong> no total.</p>
        </div>
        <div class="guide-step">
          <span>2</span>
          <p>Abra ‚ÄúRegistrar movimenta√ß√£o‚Äù e informe status, setor e colaborador (ex.: Entregue ¬∑ Desossa ¬∑ Jo√£o).</p>
        </div>
        <div class="guide-step">
          <span>3</span>
          <p>Quando sair do enxoval, clique em <strong>Inativar</strong>. Para excluir, desmarque ‚ÄúSomente ativos‚Äù.</p>
        </div>
        <div class="guide-step">
          <span>4</span>
          <p>Use filtros por c√≥digo, status, setor ou colaborador para localizar r√°pido e conferir pend√™ncias.</p>
        </div>
      </div>
    </details>
    <section class="card span-full">
      <h3>Dashboard de Gr√°ficos</h3>
      <p class="helper">Indicadores, alertas e invent√°rio consolidado em uma tela separada.</p>
      <div class="actions">
        <a href="{{ url_for('main.dashboard') }}" class="button">üìä Abrir Dashboard</a>
      </div>
    </section>

    <section class="card span-full">
      <h3>Acesso externo r√°pido</h3>
      <p class="helper">Copie a URL atual para compartilhar o acesso via Tailscale.</p>
      <div class="actions">
        <button type="button" class="button secondary" id="copiar-url">üìã Copiar URL</button>
        <span class="copy-status" id="copy-status" aria-live="polite"></span>
        <a href="{{ url_for('main.status') }}" class="button">üß≠ Ver status</a>
        <a href="{{ url_for('main.revisao') }}" class="button secondary">‚úÖ Revis√£o r√°pida</a>
      </div>
    </section>

    <section class="card span-full">
      <h3>Revis√µes pendentes</h3>
      <p class="helper">Pe√ßas aguardando confer√™ncia (periodicidade: {{ periodicidade_revisao }} dias).</p>
      <div class="summary">
        <div class="summary-card">
          <span class="label">Pendentes</span>
          <strong>{{ pendentes_revisao }}</strong>
        </div>
      </div>
      <div class="actions spaced">
        <a href="{{ url_for('main.revisao') }}" class="button">‚úÖ Ir para revis√£o</a>
        <a href="{{ url_for('main.relatorio_revisoes') }}" class="button secondary">üìÑ Relat√≥rio</a>
      </div>
    </section>

    <section class="card span-full">
      <h3>Gerenciar Cadastros</h3>
      <p class="helper">Acesse a √°rea administrativa para gerenciar colaboradores, setores, tipos de pe√ßa e tamanhos.</p>
      <div class="actions">
        <a href="{{ url_for('main.gerenciar') }}" class="button">‚öôÔ∏è Gerenciar Cadastros</a>
      </div>
    </section>

    <section class="card span-full">
      <h3>Importar enxoval (CSV)</h3>
      <p class="helper">Use quando tiver muitas pe√ßas para cadastrar de uma vez.</p>
      <form method="post" action="{{ url_for('main.importar_csv') }}" enctype="multipart/form-data">
        <label for="arquivo">Arquivo CSV</label>
        <input id="arquivo" name="arquivo" type="file" accept=".csv" required>
        <button type="submit">Importar</button>
      </form>
    </section>

    <form method="post" class="span-full">
      <span class="step">Passo 1</span>
      <p class="helper">Cadastre cada pe√ßa com c√≥digo √∫nico. RFID √© opcional.</p>
      <label for="nome">Tipo</label>
      <select id="nome" name="nome" required>
        <option value="">‚Äî Selecione ‚Äî</option>
        <option value="__novo__">+ Cadastrar novo tipo</option>
        {% for tipo in tipos_peca_ativos %}
          <option value="{{ tipo.nome }}">{{ tipo.nome }}</option>
        {% endfor %}
      </select>

      <div id="novo-tipo-container" class="inline-toggle">
        <label for="novo_tipo_nome">Nome do novo tipo</label>
        <input id="novo_tipo_nome" name="novo_tipo_nome" placeholder="Ex.: Jaleco t√©rmico">
      </div>

      <label for="codigo">C√≥digo/Rastreio</label>
      <input id="codigo" name="codigo" placeholder="Ex.: JAL-0001" required>

      <label for="tag_rfid">Tag RFID (opcional)</label>
      <input id="tag_rfid" name="tag_rfid" placeholder="Ex.: RFID-0001">

      <label for="tamanho">Tamanho</label>
      <select id="tamanho" name="tamanho" required>
        <option value="">Selecione</option>
        <option value="__novo__">+ Cadastrar novo tamanho</option>
        {% for tamanho in tamanhos_ativos %}
          <option value="{{ tamanho.nome }}">{{ tamanho.nome }}</option>
        {% endfor %}
      </select>

      <div id="novo-tamanho-container" class="inline-toggle">
        <label for="novo_tamanho_nome">Nome do novo tamanho</label>
        <input id="novo_tamanho_nome" name="novo_tamanho_nome" placeholder="Ex.: XG, PP, 42, etc.">
      </div>

      <label for="tamanho_customizado">Detalhe sob medida (opcional)</label>
      <input id="tamanho_customizado" name="tamanho_customizado" placeholder="Ex.: ajuste de manga, nome do colaborador">

      <label for="colaborador">Colaborador (opcional)</label>
      <select id="colaborador" name="colaborador">
        <option value="">‚Äî Selecione ‚Äî</option>
        <option value="__novo__">+ Cadastrar novo colaborador</option>
        {% for colaborador in colaboradores_ativos %}
          <option value="{{ colaborador.nome }}">{{ colaborador.nome }}</option>
        {% endfor %}
      </select>

      <div id="novo-colaborador-container" class="inline-toggle">
        <label for="novo_colaborador_nome">Nome do novo colaborador</label>
        <input id="novo_colaborador_nome" name="novo_colaborador_nome" placeholder="Ex.: Jo√£o Silva">
        <label for="novo_colaborador_telefone">Telefone (opcional)</label>
        <input id="novo_colaborador_telefone" name="novo_colaborador_telefone" placeholder="Ex.: (51) 99999-9999">
      </div>

      <label for="setor">Setor (opcional)</label>
      <select id="setor" name="setor">
        <option value="">‚Äî Selecione ‚Äî</option>
        <option value="__novo__">+ Cadastrar novo setor</option>
        {% for setor in setores_ativos %}
          <option value="{{ setor.nome }}">{{ setor.nome }}</option>
        {% endfor %}
      </select>

      <div id="novo-setor-container" class="inline-toggle">
        <label for="novo_setor_nome">Nome do novo setor</label>
        <input id="novo_setor_nome" name="novo_setor_nome" placeholder="Ex.: Desossa">
      </div>

      <label for="descricao">Descri√ß√£o</label>
      <textarea id="descricao" name="descricao" placeholder="Detalhes, tamanho, setor..."></textarea>

      <button type="submit">Cadastrar</button>
    </form>

    <section class="card span-full" id="lista-pecas">
      <h3>Lista de pe√ßas</h3>
      <p class="helper">Use filtros para encontrar rapidamente. A lista √© paginada.</p>
      <form method="get" class="filters" action="{{ url_for('main.index') }}#lista-pecas">
        <div>
          <label for="busca">Busca</label>
          <input id="busca" name="busca" value="{{ busca }}" placeholder="Ex.: MO-0001 ou moletom">
        </div>
        <div>
          <label for="status">Status</label>
          <select id="status" name="status">
            <option value="">Todos</option>
            {% for status in status_options %}
              <option value="{{ status }}" {% if status == filtro_status %}selected{% endif %}>{{ status|replace('_', ' ') }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="setor-filtro">Setor</label>
          <select id="setor-filtro" name="setor">
            <option value="">Todos</option>
            <option value="__sem__" {% if filtro_setor == "__sem__" %}selected{% endif %}>Sem setor</option>
            {% for setor in setores_ativos %}
              <option value="{{ setor.nome }}" {% if setor.nome == filtro_setor %}selected{% endif %}>{{ setor.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="colaborador-filtro">Colaborador</label>
          <select id="colaborador-filtro" name="colaborador">
            <option value="">Todos</option>
            <option value="__sem__" {% if filtro_colaborador == "__sem__" %}selected{% endif %}>Sem colaborador</option>
            {% for colaborador in colaboradores_ativos %}
              <option value="{{ colaborador.nome }}" {% if colaborador.nome == filtro_colaborador %}selected{% endif %}>{{ colaborador.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="por_pagina">Por p√°gina</label>
          <select id="por_pagina" name="por_pagina">
            {% for opcao in [10, 25, 50, 100] %}
              <option value="{{ opcao }}" {% if opcao == por_pagina %}selected{% endif %}>{{ opcao }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="inline">
          <input type="hidden" name="ativos" value="0">
          <input id="ativos" name="ativos" type="checkbox" value="1" {% if apenas_ativos %}checked{% endif %}>
          <label for="ativos">Somente ativos</label>
        </div>
        <button type="submit">Aplicar filtros</button>
      </form>

      <div class="table-scroll">
        <div class="main-table-wrapper">
          <table class="main-table">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Pe√ßa</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            {% for item in itens %}
              <tr>
                <td>{{ item.codigo }}</td>
                <td>
                  <strong>{{ item.nome }}</strong><br>
                  <span class="muted">{{ item.tamanho }}{% if item.colaborador %} ¬∑ {{ item.colaborador }}{% endif %}{% if item.setor %} ¬∑ {{ item.setor }}{% endif %}</span>
                  <div>
                    <div>
                    <a class="back-link" href="{{ url_for('main.item_detalhe', item_id=item.id) }}">Ver hist√≥rico</a> |
                    <a class="back-link" href="{{ url_for('main.etiqueta_item', item_id=item.id) }}" target="_blank">üñ®Ô∏è Etiqueta</a> |
                    <a class="back-link" href="{{ url_for('main.editar_item', item_id=item.id) }}">‚úèÔ∏è Editar</a>
                  </div>
                  {% if not item.ativo %}
                    <div class="meta">
                      <form method="post" action="{{ url_for('main.excluir_item', item_id=item.id) }}" class="inline-form" onsubmit="return confirm('Tem certeza que deseja EXCLUIR PERMANENTEMENTE esta pe√ßa? Esta a√ß√£o n√£o pode ser desfeita.');">
                        <button type="submit" class="link-button-danger">üóëÔ∏è Excluir Permanentemente</button>
                      </form>
                    </div>
                  {% endif %}
                </td>
                <td>
                  <span class="badge">{{ item.status|replace('_', ' ') }}</span>
                </td>
                <td>
                  {% if item.ativo %}
                    <details class="movimentacao">
                      <summary>Registrar movimenta√ß√£o</summary>
                      <span class="step">Passo 2</span>
                      <p class="helper">Atualize o status sempre que a pe√ßa mudar de local.</p>
                      <form method="post" action="{{ url_for('main.movimentar_item', item_id=item.id) }}">
                        <label for="status-{{ item.id }}">Status</label>
                        <select id="status-{{ item.id }}" name="status" required>
                          {% for status in status_options %}
                            <option value="{{ status }}" {% if status == item.status %}selected{% endif %}>{{ status|replace('_', ' ') }}</option>
                          {% endfor %}
                        </select>

                        <label for="colaborador-{{ item.id }}">Colaborador</label>
                        <select id="colaborador-{{ item.id }}" name="colaborador">
                          <option value="">‚Äî Selecione ‚Äî</option>
                          {% for colaborador in colaboradores_ativos %}
                            <option value="{{ colaborador.nome }}" {% if colaborador.nome == item.colaborador %}selected{% endif %}>{{ colaborador.nome }}</option>
                          {% endfor %}
                        </select>

                        <label for="setor-{{ item.id }}">Setor</label>
                        <select id="setor-{{ item.id }}" name="setor">
                          <option value="">‚Äî Selecione ‚Äî</option>
                          {% for setor in setores_ativos %}
                            <option value="{{ setor.nome }}" {% if setor.nome == item.setor %}selected{% endif %}>{{ setor.nome }}</option>
                          {% endfor %}
                        </select>

                        <label for="observacao-{{ item.id }}">Observa√ß√£o</label>
                        <input id="observacao-{{ item.id }}" name="observacao" placeholder="Ex.: retirado na rouparia">

                        <button type="submit">Registrar movimenta√ß√£o</button>
                      </form>
                      <form method="post" action="{{ url_for('main.inativar_item', item_id=item.id) }}">
                        <button type="submit">Inativar</button>
                      </form>
                    </details>
                  {% else %}
                    <span class="muted">‚Äî</span>
                  {% endif %}
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="4" class="muted">Nenhum item encontrado.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="pagination">
        <span>P√°gina {{ pagina }} de {{ total_paginas }} ({{ total_itens }} itens)</span>
        {% if pagina > 1 %}
          <a href="{{ url_for('main.index', pagina=pagina-1, busca=busca, status=filtro_status, setor=filtro_setor, colaborador=filtro_colaborador, ativos=1 if apenas_ativos else 0, por_pagina=por_pagina) }}#lista-pecas">Anterior</a>
        {% endif %}
        {% if pagina < total_paginas %}
          <a href="{{ url_for('main.index', pagina=pagina+1, busca=busca, status=filtro_status, setor=filtro_setor, colaborador=filtro_colaborador, ativos=1 if apenas_ativos else 0, por_pagina=por_pagina) }}#lista-pecas">Pr√≥xima</a>
        {% endif %}
      </div>
    </section>
  </div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const copyButton = document.getElementById('copiar-url');
    const copyStatus = document.getElementById('copy-status');

    if (copyButton) {
      copyButton.addEventListener('click', async function() {
        const url = window.location.origin;
        let copied = false;

        if (navigator.clipboard && window.isSecureContext) {
          try {
            await navigator.clipboard.writeText(url);
            copied = true;
          } catch (err) {
            copied = false;
          }
        }

        if (!copied) {
          const tempInput = document.createElement('input');
          tempInput.value = url;
          document.body.appendChild(tempInput);
          tempInput.select();
          try {
            copied = document.execCommand('copy');
          } catch (err) {
            copied = false;
          }
          document.body.removeChild(tempInput);
        }

        if (copied) {
          copyStatus.textContent = `URL copiada: ${url}`;
        } else {
          copyStatus.textContent = `Copie manualmente: ${url}`;
          window.prompt('Copie a URL abaixo:', url);
        }
      });
    }

    // Setor select handler
    const setorSelect = document.getElementById('setor');
    const novoSetorContainer = document.getElementById('novo-setor-container');
    const novoSetorInput = document.getElementById('novo_setor_nome');
    
    if (setorSelect && novoSetorContainer) {
      setorSelect.addEventListener('change', function() {
        if (this.value === '__novo__') {
          novoSetorContainer.style.display = 'block';
          novoSetorInput.setAttribute('required', 'required');
        } else {
          novoSetorContainer.style.display = 'none';
          novoSetorInput.removeAttribute('required');
          novoSetorInput.value = '';
        }
      });
    }

    // Tamanho select handler
    const tamanhoSelect = document.getElementById('tamanho');
    const novoTamanhoContainer = document.getElementById('novo-tamanho-container');
    const novoTamanhoInput = document.getElementById('novo_tamanho_nome');
    
    if (tamanhoSelect && novoTamanhoContainer) {
      tamanhoSelect.addEventListener('change', function() {
        if (this.value === '__novo__') {
          novoTamanhoContainer.style.display = 'block';
          novoTamanhoInput.setAttribute('required', 'required');
        } else {
          novoTamanhoContainer.style.display = 'none';
          novoTamanhoInput.removeAttribute('required');
          novoTamanhoInput.value = '';
        }
      });
    }

    // Tipo peca select handler
    const tipoSelect = document.getElementById('nome');
    const novoTipoContainer = document.getElementById('novo-tipo-container');
    const novoTipoInput = document.getElementById('novo_tipo_nome');
    
    if (tipoSelect && novoTipoContainer) {
      tipoSelect.addEventListener('change', function() {
        if (this.value === '__novo__') {
          novoTipoContainer.style.display = 'block';
          novoTipoInput.setAttribute('required', 'required');
        } else {
          novoTipoContainer.style.display = 'none';
          novoTipoInput.removeAttribute('required');
          novoTipoInput.value = '';
        }
      });
    }

    // Colaborador select handler
    const colaboradorSelect = document.getElementById('colaborador');
    const novoColaboradorContainer = document.getElementById('novo-colaborador-container');
    const novoColaboradorInput = document.getElementById('novo_colaborador_nome');
    
    if (colaboradorSelect && novoColaboradorContainer) {
      colaboradorSelect.addEventListener('change', function() {
        if (this.value === '__novo__') {
          novoColaboradorContainer.style.display = 'block';
          novoColaboradorInput.setAttribute('required', 'required');
        } else {
          novoColaboradorContainer.style.display = 'none';
          novoColaboradorInput.removeAttribute('required');
          novoColaboradorInput.value = '';
        }
      });
    }
  });
</script>
{% endblock %}
