{% extends 'base.html' %}

{% block content %}
  <div class="grid">
    <section class="summary">
      <div class="summary-card">
        <span class="label">Peças ativas</span>
        <strong>{{ total_ativos }}</strong>
      </div>
      <div class="summary-card">
        <span class="label">Pendentes de retorno</span>
        <strong>{{ pendentes }}</strong>
      </div>
      <div class="summary-card">
        <span class="label">Extraviadas</span>
        <strong>{{ extraviados }}</strong>
      </div>
      <div class="summary-card">
        <span class="label">Em estoque</span>
        <strong>{{ status_counts.get('estoque', 0) }}</strong>
      </div>
    </section>
    <p class="helper">
      Passo a passo: 1) cadastre as peças, 2) registre cada movimentação, 3) acompanhe pendências e perdas.
    </p>
    <section class="card">
      <h3>Alertas automáticos</h3>
      <p class="helper">Peças em uso/entregues sem movimentação há mais de 2 dias.</p>
      <div class="alert-grid">
        <div class="summary-card">
          <span class="label">Atenção (2+ dias)</span>
          <strong class="badge alerta">{{ alerta_total.atencao }}</strong>
        </div>
        <div class="summary-card">
          <span class="label">Crítico (4+ dias)</span>
          <strong class="badge critico">{{ alerta_total.critico }}</strong>
        </div>
      </div>
      <div class="grid">
        <section class="card">
          <h4>Por setor</h4>
          <table>
            <thead>
              <tr>
                <th>Setor</th>
                <th>Atenção</th>
                <th>Crítico</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              {% for setor, atencao, critico, total in alertas_setor %}
                <tr>
                  <td>{{ setor }}</td>
                  <td>{{ atencao }}</td>
                  <td>{{ critico }}</td>
                  <td>{{ total }}</td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="4" class="muted">Sem alertas no momento.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </section>
        <section class="card">
          <h4>Por colaborador</h4>
          <table>
            <thead>
              <tr>
                <th>Colaborador</th>
                <th>Atenção</th>
                <th>Crítico</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              {% for colaborador, atencao, critico, total in alertas_colaborador %}
                <tr>
                  <td>{{ colaborador }}</td>
                  <td>{{ atencao }}</td>
                  <td>{{ critico }}</td>
                  <td>{{ total }}</td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="4" class="muted">Sem alertas no momento.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </section>
      </div>
    </section>
    <section class="card">
      <h3>Dashboard com gráficos</h3>
      <div class="chart-grid">
        <section class="card">
          <h4>Status do enxoval</h4>
          <div class="donut" data-conic="{{ status_conic }}"></div>
          <div class="legend">
            {% for item in status_chart %}
              <div class="legend-item">
                <span class="legend-dot" data-color="{{ item.color }}"></span>
                <span>{{ item.status|replace('_', ' ') }} ({{ item.quantidade }})</span>
              </div>
            {% endfor %}
          </div>
        </section>
        <section class="card">
          <h4>Por tipo</h4>
          {% for tipo, total in por_tipo %}
            <div class="bar-row">
              <div class="bar-label">
                <span>{{ tipo }}</span>
                <span>{{ total }}</span>
              </div>
              <div class="bar-track">
                <div class="bar-fill" data-width="{{ (total / max_tipo) * 100 }}"></div>
              </div>
            </div>
          {% endfor %}
        </section>
        <section class="card">
          <h4>Por setor</h4>
          {% for setor, total in por_setor %}
            <div class="bar-row">
              <div class="bar-label">
                <span>{{ setor or 'Sem setor' }}</span>
                <span>{{ total }}</span>
              </div>
              <div class="bar-track">
                <div class="bar-fill" data-width="{{ (total / max_setor) * 100 }}"></div>
              </div>
            </div>
          {% endfor %}
        </section>
      </div>
    </section>
    <section class="card">
      <h3>Inventário por tipo</h3>
      <p class="helper">Mostra quantas peças ativas existem por tipo (moletom, calça, bata...).</p>
      <table>
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Quantidade</th>
          </tr>
        </thead>
        <tbody>
          {% for tipo, total in por_tipo %}
            <tr>
              <td>{{ tipo }}</td>
              <td>{{ total }}</td>
            </tr>
          {% else %}
            <tr>
              <td colspan="2" class="muted">Sem dados.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <section class="card">
      <h3>Inventário por setor</h3>
      <p class="helper">Ajuda a ver onde o enxoval está concentrado no frigorífico.</p>
      <table>
        <thead>
          <tr>
            <th>Setor</th>
            <th>Quantidade</th>
          </tr>
        </thead>
        <tbody>
          {% for setor, total in por_setor %}
            <tr>
              <td>{{ setor or 'Sem setor' }}</td>
              <td>{{ total }}</td>
            </tr>
          {% else %}
            <tr>
              <td colspan="2" class="muted">Sem dados.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <section class="card">
      <h3>Importar enxoval (CSV)</h3>
      <p class="helper">Use quando tiver muitas peças para cadastrar de uma vez.</p>
      <form method="post" action="{{ url_for('main.importar_csv') }}" enctype="multipart/form-data">
        <label for="arquivo">Arquivo CSV</label>
        <input id="arquivo" name="arquivo" type="file" accept=".csv" required>
        <button type="submit">Importar</button>
      </form>
    </section>

    <form method="post">
      <span class="step">Passo 1</span>
      <p class="helper">Cadastre cada peça com código único. RFID é opcional.</p>
      <label for="nome">Nome da peça</label>
      <input id="nome" name="nome" placeholder="Ex.: Jaleco térmico" required>

      <label for="codigo">Código/Rastreio</label>
      <input id="codigo" name="codigo" placeholder="Ex.: JAL-0001" required>

      <label for="tag_rfid">Tag RFID (opcional)</label>
      <input id="tag_rfid" name="tag_rfid" placeholder="Ex.: RFID-0001">

      <label for="tamanho">Tamanho</label>
      <select id="tamanho" name="tamanho" required>
        <option value="">Selecione</option>
        <option value="P">P</option>
        <option value="M">M</option>
        <option value="G">G</option>
        <option value="GG">GG</option>
        <option value="SOB MEDIDA">Sob medida</option>
      </select>

      <label for="tamanho_customizado">Detalhe sob medida (opcional)</label>
      <input id="tamanho_customizado" name="tamanho_customizado" placeholder="Ex.: ajuste de manga, nome do colaborador">

      <label for="colaborador">Colaborador (opcional)</label>
      <input id="colaborador" name="colaborador" placeholder="Ex.: João Silva">

      <label for="setor">Setor (opcional)</label>
      <input id="setor" name="setor" placeholder="Ex.: Desossa">

      <label for="descricao">Descrição</label>
      <textarea id="descricao" name="descricao" placeholder="Detalhes, tamanho, setor..."></textarea>

      <button type="submit">Cadastrar</button>
    </form>

    <div>
      <table>
        <thead>
          <tr>
            <th>Código</th>
            <th>Peça</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for item in itens %}
            <tr>
              <td>{{ item.codigo }}</td>
              <td>
                <strong>{{ item.nome }}</strong><br>
                <span class="muted">{{ item.tamanho }}{% if item.colaborador %} · {{ item.colaborador }}{% endif %}{% if item.setor %} · {{ item.setor }}{% endif %}</span>
                <div>
                  <a class="back-link" href="{{ url_for('main.item_detalhe', item_id=item.id) }}">Ver histórico</a>
                </div>
              </td>
              <td>
                <span class="badge">{{ item.status|replace('_', ' ') }}</span>
              </td>
              <td>
                {% if item.ativo %}
                  <span class="step">Passo 2</span>
                  <p class="helper">Atualize o status sempre que a peça mudar de local.</p>
                  <form method="post" action="{{ url_for('main.inativar_item', item_id=item.id) }}">
                    <button type="submit">Inativar</button>
                  </form>
                  <form method="post" action="{{ url_for('main.movimentar_item', item_id=item.id) }}">
                    <label for="status-{{ item.id }}">Status</label>
                    <select id="status-{{ item.id }}" name="status" required>
                      {% for status in status_options %}
                        <option value="{{ status }}" {% if status == item.status %}selected{% endif %}>{{ status|replace('_', ' ') }}</option>
                      {% endfor %}
                    </select>

                    <label for="colaborador-{{ item.id }}">Colaborador</label>
                    <input id="colaborador-{{ item.id }}" name="colaborador" value="{{ item.colaborador or '' }}">

                    <label for="setor-{{ item.id }}">Setor</label>
                    <input id="setor-{{ item.id }}" name="setor" value="{{ item.setor or '' }}">

                    <label for="observacao-{{ item.id }}">Observação</label>
                    <input id="observacao-{{ item.id }}" name="observacao" placeholder="Ex.: retirado na rouparia">

                    <button type="submit">Registrar movimentação</button>
                  </form>
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="4" class="muted">Nenhum item cadastrado ainda.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}
