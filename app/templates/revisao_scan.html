{% extends 'base.html' %}

{% block content %}
  <div class="grid">
    <section class="card span-full">
      <a href="{{ url_for('main.revisao') }}" class="back-link">‚Üê Voltar para revis√£o</a>
      <h3>Revis√£o por QR Code</h3>
      <p class="helper">Use a c√¢mera do celular para ler o QR Code e confirmar a pe√ßa.</p>

      <div class="scanner-grid">
        <div>
          <label for="conferente">Nome do conferente</label>
          <input id="conferente" name="conferente" placeholder="Ex.: Maria" required>
        </div>

        <video id="scanner" class="scanner-video" autoplay playsinline></video>

        <div class="actions">
          <button type="button" id="iniciar-scan">üé• Iniciar c√¢mera</button>
          <button type="button" id="parar-scan" class="button secondary">‚èπÔ∏è Parar</button>
          <span class="scanner-status" id="scanner-status">Aguardando leitura.</span>
        </div>

        <div>
          <label for="codigo-manual">Ou digite o c√≥digo manualmente</label>
          <div class="actions">
            <input id="codigo-manual" placeholder="Ex.: JAL-0001">
            <button type="button" id="enviar-manual" class="button secondary">Enviar</button>
          </div>
        </div>
      </div>
    </section>
  </div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const video = document.getElementById('scanner');
    const iniciar = document.getElementById('iniciar-scan');
    const parar = document.getElementById('parar-scan');
    const statusEl = document.getElementById('scanner-status');
    const conferenteInput = document.getElementById('conferente');
    const manualInput = document.getElementById('codigo-manual');
    const manualBtn = document.getElementById('enviar-manual');

    let stream = null;
    let detector = null;
    let scanning = false;

    async function enviarCodigo(codigo, raw = '') {
      const conferente = (conferenteInput.value || '').trim();
      if (!conferente) {
        statusEl.textContent = 'Informe o conferente antes de confirmar.';
        return;
      }

      statusEl.textContent = 'Registrando revis√£o...';
      const response = await fetch("{{ url_for('main.revisao_scan') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ codigo, raw, conferente })
      });
      const data = await response.json();
      statusEl.textContent = data.mensagem || 'Leitura conclu√≠da.';
    }

    async function iniciarCamera() {
      if (scanning) return;
      if (!('BarcodeDetector' in window)) {
        statusEl.textContent = 'Leitor nativo n√£o suportado. Use a digita√ß√£o manual.';
        return;
      }

      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        detector = new BarcodeDetector({ formats: ['qr_code'] });
        scanning = true;
        statusEl.textContent = 'C√¢mera ativa. Aponte para o QR Code.';
        scanLoop();
      } catch (err) {
        statusEl.textContent = 'N√£o foi poss√≠vel acessar a c√¢mera.';
      }
    }

    async function scanLoop() {
      if (!scanning || !detector) return;
      try {
        const barcodes = await detector.detect(video);
        if (barcodes.length > 0) {
          const raw = barcodes[0].rawValue || '';
          await enviarCodigo('', raw);
        }
      } catch (err) {
        statusEl.textContent = 'Erro ao ler o QR Code.';
      }
      requestAnimationFrame(scanLoop);
    }

    function pararCamera() {
      scanning = false;
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      stream = null;
      statusEl.textContent = 'C√¢mera pausada.';
    }

    iniciar.addEventListener('click', iniciarCamera);
    parar.addEventListener('click', pararCamera);

    manualBtn.addEventListener('click', () => {
      const codigo = (manualInput.value || '').trim();
      if (!codigo) {
        statusEl.textContent = 'Digite o c√≥digo da pe√ßa.';
        return;
      }
      enviarCodigo(codigo);
    });
  });
</script>
{% endblock %}
